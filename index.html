<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é‘°åŒ™å­”å·çªºè§£è¬</title>
    
    <!-- å¼•å…¥è¨­å®šæª” -->
    <script src="config.js" onerror="window.configLoadError = true;"></script>
    
    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #000;
            font-family: 'Courier New', Courier, monospace;
            user-select: none; -webkit-user-select: none;
            overscroll-behavior: none;
            touch-action: none;
        }
        #game-container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }

        /* === å¼·åˆ¶æ©«å¼æç¤ºå±¤ === */
        #portrait-blocker {
            display: none; /* é è¨­éš±è— */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 99999;
            flex-direction: column; justify-content: center; align-items: center;
            color: #fff; text-align: center;
        }
        #portrait-blocker .icon { font-size: 60px; margin-bottom: 20px; animation: rotate-icon 2s infinite; }
        #portrait-blocker p { font-size: 20px; color: #aaa; }

        @keyframes rotate-icon {
            0% { transform: rotate(0deg); }
            20% { transform: rotate(-90deg); }
            80% { transform: rotate(-90deg); }
            100% { transform: rotate(0deg); }
        }

        /* é€é CSS Media Query åµæ¸¬ç›´å¼ï¼Œå¼·åˆ¶é¡¯ç¤ºé®ç½© */
        @media screen and (orientation: portrait) {
            #portrait-blocker { display: flex !important; }
            #game-container { visibility: hidden; } /* éš±è—éŠæˆ²å…§å®¹ä½†ä¿ç•™çµæ§‹ */
        }

        /* éŒ¯èª¤è¨Šæ¯ */
        #error-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(20, 0, 0, 0.95); z-index: 9999;
            flex-direction: column; justify-content: center; align-items: center;
            color: #ff5555; text-align: center; padding: 20px;
        }
        #error-msg { 
            background: #220000; padding: 20px; border: 1px solid #ff5555; 
            max-width: 90%; white-space: pre-wrap; font-size: 16px; line-height: 1.6; text-align: left;
        }

        /* éŠæˆ²åœ–å±¤ */
        #room-layer {
            position: absolute; width: 120vw; height: 120vh; left: -10vw; top: -10vh;
            background-repeat: no-repeat; background-position: center center; background-size: cover;
            will-change: transform; 
            z-index: 1;
        }
        .clue-paper {
            position: absolute; width: 100px; height: 120px; background-color: #f8f1e5;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.7); display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: #800; border: 1px solid #ccc; z-index: 5;
        }
        .clue-paper span { font-size: 14px; color: #555; margin-bottom: 5px; }
        .clue-paper strong { font-size: 32px; font-family: 'Times New Roman', serif; letter-spacing: 2px; }
        .tape {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%) rotate(-2deg);
            width: 40px; height: 15px; background-color: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* é®ç½©å®¹å™¨ */
        #mask-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10;
            display: flex; justify-content: center; align-items: center;
        }
        #keyhole-svg { width: 100%; height: 100%; display: none; }
        #mask-shape-group { transform-origin: 50px 50px; transition: transform 0.3s ease; }
        #keyhole-image-layer {
            width: 100%; height: 100%; object-fit: cover; display: none; transition: transform 0.3s ease;
        }

        #vignette {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 11;
            background: radial-gradient(circle at center, transparent 10%, rgba(0,0,0,0.6) 50%, #000 80%);
        }

        /* UI å±¤ */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100;
            color: white; text-align: center; padding: 20px; transition: opacity 0.5s;
        }
        h1 { color: #d00; text-shadow: 0 0 10px #500; font-size: 2rem; margin-bottom: 10px; }
        button {
            margin-top: 20px; padding: 15px 40px; font-size: 1.2rem;
            background: transparent; color: #d00; border: 2px solid #d00; border-radius: 5px;
            cursor: pointer; transition: all 0.3s; font-weight: bold;
        }
        button:hover { background: #d00; color: #fff; box-shadow: 0 0 20px #d00; }
        
        .debug-info { position: absolute; bottom: 10px; left: 10px; color: lime; font-size: 12px; z-index: 50; pointer-events: none; opacity: 0.6; }
    </style>
</head>
<body>

    <!-- ç›´å¼é˜»æ“‹å±¤ -->
    <div id="portrait-blocker">
        <div class="icon">ğŸ“± â†ªï¸</div>
        <p>ç‚ºäº†æœ€ä½³é«”é©—<br>è«‹å°‡è£ç½®è½‰ç‚ºæ©«å‘ (Landscape)</p>
    </div>

    <div id="game-container">
        <div id="error-overlay">
            <h2 style="color:#fff">âš ï¸ ç™¼ç”ŸéŒ¯èª¤</h2>
            <div id="error-msg"></div>
            <button onclick="location.reload()" style="margin-top:20px;">é‡è©¦</button>
        </div>

        <div id="room-layer">
            <div id="clue-element" class="clue-paper">
                <div class="tape"></div>
                <span id="clue-text"></span>
                <strong id="clue-code"></strong>
            </div>
            <div style="position:absolute; bottom:20%; right:10%; width:200px; height:300px; background:rgba(0,0,0,0.6); filter:blur(20px);"></div>
        </div>

        <div id="vignette"></div>

        <div id="mask-container">
            <svg id="keyhole-svg" viewBox="0 0 100 100" preserveAspectRatio="none">
                <defs>
                    <mask id="hole-mask">
                        <rect x="0" y="0" width="100" height="100" fill="white" />
                        <g id="mask-shape-group"></g>
                    </mask>
                </defs>
                <rect x="0" y="0" width="100" height="100" fill="black" mask="url(#hole-mask)" />
            </svg>
            <img id="keyhole-image-layer" src="" alt="Mask" />
        </div>

        <div id="start-screen">
            <h1 id="ui-title">çªºè¦–æ·±æ·µ</h1>
            <p id="ui-desc">...</p>
            <button id="start-btn">é–‹å§‹</button>
            <p style="font-size: 12px; color: #666; margin-top: 20px;">(åƒ…æ”¯æ´æ©«å‘éŠç©)</p>
        </div>

        <div class="debug-info" id="debug">System Init...</div>
    </div>

    <script>
        const roomLayer = document.getElementById('room-layer');
        const startScreen = document.getElementById('start-screen');
        const startBtn = document.getElementById('start-btn');
        const debugText = document.getElementById('debug');
        const errorOverlay = document.getElementById('error-overlay');
        const errorMsg = document.getElementById('error-msg');
        
        const clueEl = document.getElementById('clue-element');
        const clueTextEl = document.getElementById('clue-text');
        const clueCodeEl = document.getElementById('clue-code');
        const uiTitle = document.getElementById('ui-title');
        const uiDesc = document.getElementById('ui-desc');
        const svgEl = document.getElementById('keyhole-svg');
        const maskGroup = document.getElementById('mask-shape-group');
        const imgEl = document.getElementById('keyhole-image-layer');

        const FallbackConfig = {
            title: "çªºè¦–æ·±æ·µ",
            description: "æˆ¿é–“çš„æŸå€‹è§’è½è—è‘—ä¸€çµ„å¯†ç¢¼...",
            startButtonText: "é–‹å§‹çªºè¦–",
            backgroundImage: 'https://images.unsplash.com/photo-1519074069444-1ba4fff66d16?q=80&w=2574&auto=format&fit=crop',
            mask: { mode: 'svg', scale: 1.0, shapes: `<circle cx="50" cy="40" r="15" fill="black" /><path d="M50 40 L65 90 L35 90 Z" fill="black" />` },
            clue: { show: true, text: "DEMO", code: "9527", top: "15%", left: "15%", rotation: -5 },
            gameplay: { maxMoveX: 50, maxMoveY: 50, smoothFactor: 0.3, limitAngle: 35 }
        };

        let Config = null;
        let isRunning = false;
        
        let lastRawX = null;
        let lastRawY = null;
        let accumulatedX = 0;
        let accumulatedY = 0;
        
        // æ¸²æŸ“è®Šæ•¸
        let currentRenderX = 0;
        let currentRenderY = 0;
        let targetX = 0;
        let targetY = 0;

        function showError(msg) {
            errorOverlay.style.display = 'flex';
            errorMsg.innerText = msg;
            startScreen.style.display = 'none';
        }

        function initSystem() {
            Config = (typeof GameConfig !== 'undefined') ? GameConfig : FallbackConfig;
            
            if (typeof GameConfig === 'undefined') {
                debugText.innerText = "Mode: Fallback";
                debugText.style.color = "yellow";
            }

            if (!Config.gameplay) Config.gameplay = FallbackConfig.gameplay;
            
            // å¼·åˆ¶è¨­å®šé«˜æ•ˆèƒ½åƒæ•¸
            Config.gameplay.limitAngle = 35; 
            Config.gameplay.maxMoveX = 50;
            Config.gameplay.maxMoveY = 50;
            Config.gameplay.smoothFactor = 0.3;

            if (Config.title) uiTitle.innerText = Config.title;
            if (Config.description) uiDesc.innerText = Config.description;
            if (Config.startButtonText) startBtn.innerText = Config.startButtonText;

            const maskConfig = Config.mask || FallbackConfig.mask;
            const mode = maskConfig.mode || 'svg';
            const scale = maskConfig.scale || 1.0;

            if (mode === 'image') {
                svgEl.style.display = 'none';
                imgEl.style.display = 'block';
                if (maskConfig.imageSrc) {
                    imgEl.src = maskConfig.imageSrc;
                    imgEl.style.transform = `scale(${scale})`;
                }
            } else {
                imgEl.style.display = 'none';
                svgEl.style.display = 'block';
                maskGroup.innerHTML = maskConfig.shapes || FallbackConfig.mask.shapes;
                maskGroup.style.transform = `scale(${scale})`;
            }

            const imgUrl = Config.backgroundImage || FallbackConfig.backgroundImage;
            const testImg = new Image();
            testImg.onload = () => {
                roomLayer.style.backgroundImage = `url('${imgUrl}')`;
                if(Config === GameConfig) debugText.innerText = "System Ready.";
                applyConfig();
            };
            testImg.onerror = () => { showError(`ç„¡æ³•è¼‰å…¥èƒŒæ™¯åœ–ç‰‡ï¼š${imgUrl}`); };
            testImg.src = imgUrl;
        }

        function applyConfig() {
            const safeBuffer = 10;
            const widthVW = 100 + (Config.gameplay.maxMoveX * 2) + safeBuffer; 
            const heightVH = 100 + (Config.gameplay.maxMoveY * 2) + safeBuffer;
            roomLayer.style.width = `${widthVW}vw`;
            roomLayer.style.height = `${heightVH}vh`;
            roomLayer.style.left = `-${(widthVW - 100) / 2}vw`;
            roomLayer.style.top = `-${(heightVH - 100) / 2}vh`;

            if (Config.clue.show) {
                clueTextEl.innerText = Config.clue.text;
                clueCodeEl.innerText = Config.clue.code;
                clueEl.style.top = Config.clue.top;
                clueEl.style.left = Config.clue.left;
                clueEl.style.transform = `rotate(${Config.clue.rotation}deg)`;
            } else {
                clueEl.style.display = 'none';
            }
        }

        startBtn.addEventListener('click', async () => {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permissionState = await DeviceOrientationEvent.requestPermission();
                    if (permissionState === 'granted') startGame();
                    else alert('éœ€è¦é™€èºå„€æ¬Šé™');
                } catch (e) { startGame(); }
            } else {
                startGame();
            }
        });
        
        function startGame() {
            startScreen.style.opacity = '0';
            setTimeout(() => { startScreen.style.display = 'none'; }, 500);
            
            isRunning = true;
            
            // é‡ç½®æ‰€æœ‰æ•¸å€¼
            lastRawX = null;
            lastRawY = null;
            accumulatedX = 0;
            accumulatedY = 0;

            window.addEventListener('deviceorientation', handleOrientation);
            window.addEventListener('mousemove', handleMouse); 
            requestAnimationFrame(gameLoop);
        }

        // ==========================================
        // [æ©«å¼å°ˆç”¨] é™€èºå„€è™•ç†é‚è¼¯
        // ==========================================
        function handleOrientation(e) {
            // ç”±æ–¼æˆ‘å€‘ç”¨ CSS å¼·åˆ¶æ©«å¼ï¼Œé€™è£¡å‡è¨­ç©å®¶å·²ç¶“å°‡è£ç½®è½‰æ©«
            // ä½†æˆ‘å€‘ä»éœ€åµæ¸¬æ—‹è½‰æ–¹å‘ (å·¦è½‰90åº¦ æˆ– å³è½‰-90åº¦) ä¾†æ±ºå®šè»¸å‘æ­£è² 
            
            const screenAngle = (screen.orientation && screen.orientation.angle) || window.orientation || 90;
            
            let rawBeta = e.beta;   // å‰å¾Œå‚¾æ–œ (-180 ~ 180)
            let rawGamma = e.gamma; // å·¦å³å‚¾æ–œ (-90 ~ 90)

            if (rawBeta === null || rawGamma === null) return;

            let inputX, inputY;

            // æ©«å¼åˆ¤æ–·é‚è¼¯ (Landscape Logic Only)
            if (screenAngle === 90) { 
                // Home éµåœ¨å³ / é¡é ­åœ¨å·¦ (æœ€å¸¸è¦‹)
                // Beta æ§åˆ¶ X è»¸ (å·¦å³)ï¼ŒGamma æ§åˆ¶ Y è»¸ (ä¸Šä¸‹)
                inputX = rawBeta; 
                inputY = -rawGamma; 
            } 
            else if (screenAngle === -90 || screenAngle === 270) { 
                // Home éµåœ¨å·¦ / é¡é ­åœ¨å³
                inputX = -rawBeta;
                inputY = rawGamma;
            } 
            else { 
                // å¦‚æœç©å®¶é‚„åœ¨ç›´å¼ (é›–ç„¶è¢« CSS æ“‹ä½äº†)ï¼Œæˆ‘å€‘æš«åœæ›´æ–°
                // ç›´åˆ°ä»–è½‰å›ä¾†
                return; 
            }

            // åˆå§‹åŒ–ä¸Šä¸€å¹€
            if (lastRawX === null || lastRawY === null) {
                lastRawX = inputX;
                lastRawY = inputY;
                return;
            }

            // è¨ˆç®—è®ŠåŒ–é‡ (Delta)
            let deltaX = inputX - lastRawX;
            let deltaY = inputY - lastRawY;

            // [é—œéµ] è™•ç†æ©«å¼ç¿»è½‰çš„é‚Šç•Œå•é¡Œ (+/- 180åº¦)
            // ç•¶è£ç½®ç¿»é¢æ™‚ï¼ŒBeta æœƒåœ¨ 180 å’Œ -180 ä¹‹é–“è·³è®Š
            if (deltaX > 180) deltaX -= 360;
            if (deltaX < -180) deltaX += 360;
            if (deltaY > 180) deltaY -= 360;
            if (deltaY < -180) deltaY += 360;

            // ç´¯åŠ è®ŠåŒ–é‡ (ç´¯ç©è§’åº¦)
            // é€™ç¨®æ–¹å¼å¯ä»¥ç„¡é™æ—‹è½‰ï¼Œä¸æœƒè¢«çµ•å°åº§æ¨™é™åˆ¶ä½ï¼Œè§£æ±ºäº†é‚Šç·£äº‚è·³å•é¡Œ
            accumulatedX += deltaX;
            accumulatedY += deltaY;

            // æ›´æ–°ä¸Šä¸€å¹€
            lastRawX = inputX;
            lastRawY = inputY;

            // é™åˆ¶æœ€å¤§å¯è¦–ç¯„åœ (Soft Clamp)
            const lim = Config.gameplay.limitAngle || 35;
            
            if (accumulatedX > lim) accumulatedX = lim;
            if (accumulatedX < -lim) accumulatedX = -lim;
            if (accumulatedY > lim) accumulatedY = lim;
            if (accumulatedY < -lim) accumulatedY = -lim;

            // è¨ˆç®—ç›®æ¨™ CSS æ•¸å€¼
            targetX = (accumulatedX / lim) * -Config.gameplay.maxMoveX;
            targetY = (accumulatedY / lim) * -Config.gameplay.maxMoveY;

            debugText.innerText = `X: ${Math.round(accumulatedX)} Y: ${Math.round(accumulatedY)}`;
        }

        function handleMouse(e) {
            targetX = ((e.clientX - window.innerWidth/2)/(window.innerWidth/2)) * -Config.gameplay.maxMoveX;
            targetY = ((e.clientY - window.innerHeight/2)/(window.innerHeight/2)) * -Config.gameplay.maxMoveY;
        }

        function gameLoop() {
            if (!isRunning) return;
            
            // å‹•æ…‹å¹³æ»‘ä¿‚æ•¸ï¼šæ ¹æ“šè·é›¢å‹•æ…‹èª¿æ•´ï¼Œå…¼é¡§ç©©å®šèˆ‡åæ‡‰
            let dist = Math.sqrt(Math.pow(targetX - currentRenderX, 2) + Math.pow(targetY - currentRenderY, 2));
            let sm = (dist > 1.0) ? 0.3 : 0.15; // å¤§å‹•å¿«è¿½ï¼Œå°å‹•æ…¢ä¿®
            
            if (dist < 0.05) {
                currentRenderX = targetX;
                currentRenderY = targetY;
            } else {
                currentRenderX += (targetX - currentRenderX) * sm;
                currentRenderY += (targetY - currentRenderY) * sm;
            }

            roomLayer.style.transform = `translate3d(${currentRenderX}vw, ${currentRenderY}vh, 0)`;
            
            requestAnimationFrame(gameLoop);
        }

        initSystem();
    </script>
</body>
</html>
